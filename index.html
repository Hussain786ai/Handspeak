<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>HANDSPEAK PRO</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#030308;--s1:#08080f;--s2:#0d0d1a;--border:#1a1a30;--a:#00e5ff;--a2:#ff2d6b;--a3:#ffe500;--a4:#00ff88;--text:#dde4f0;--muted:#4a4a70;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;overflow:hidden;}
#app{display:flex;flex-direction:column;height:100dvh;width:100vw;}

header{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:rgba(3,3,8,0.97);z-index:20;}
.logo{font-family:'Orbitron',monospace;font-size:clamp(0.9rem,4vw,1.4rem);font-weight:900;letter-spacing:0.08em;background:linear-gradient(135deg,var(--a),var(--a4));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.logo sup{font-size:0.5em;vertical-align:super;}
.hr{display:flex;align-items:center;gap:6px;}

.camBtn{display:none;align-items:center;gap:4px;background:var(--s2);border:1px solid var(--a);padding:5px 10px;border-radius:8px;cursor:pointer;font-family:'Rajdhani',sans-serif;font-size:0.65rem;letter-spacing:0.08em;color:var(--a);transition:all 0.2s;}
.camBtn:active{background:var(--a);color:#000;}
.pill{display:flex;align-items:center;gap:5px;background:var(--s2);border:1px solid var(--border);padding:5px 10px;border-radius:100px;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--muted);transition:all 0.3s;}
.dot.live{background:var(--a4);box-shadow:0 0 6px var(--a4);animation:blink 1.5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

.camwrap{position:relative;flex:1;overflow:hidden;background:#020205;}
#vid{width:100%;height:100%;object-fit:cover;display:block;}
#vid.mir{transform:scaleX(-1);}
#cvs{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}
#cvs.mir{transform:scaleX(-1);}
.scan{position:absolute;inset:0;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,255,0.012) 3px,rgba(0,229,255,0.012) 4px);}
.cn{position:absolute;width:18px;height:18px;pointer-events:none;}
.cn.tl{top:8px;left:8px;border-top:2px solid var(--a);border-left:2px solid var(--a);}
.cn.tr{top:8px;right:8px;border-top:2px solid var(--a);border-right:2px solid var(--a);}
.cn.bl{bottom:8px;left:8px;border-bottom:2px solid var(--a);border-left:2px solid var(--a);}
.cn.br{bottom:8px;right:8px;border-bottom:2px solid var(--a);border-right:2px solid var(--a);}

.ph{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;cursor:pointer;}
.ph-ring{width:clamp(80px,22vw,110px);height:clamp(80px,22vw,110px);border-radius:50%;border:2px solid var(--a);display:flex;align-items:center;justify-content:center;font-size:clamp(2rem,10vw,3rem);animation:rp 2.5s infinite;}
@keyframes rp{0%,100%{box-shadow:0 0 30px rgba(0,229,255,0.2),inset 0 0 30px rgba(0,229,255,0.04);}50%{box-shadow:0 0 60px rgba(0,229,255,0.5),inset 0 0 50px rgba(0,229,255,0.1);}}
.ph-label{font-family:'Orbitron',monospace;font-size:0.7rem;color:var(--a);letter-spacing:0.15em;}
.ph-sub{font-size:0.72rem;color:var(--muted);text-align:center;max-width:220px;line-height:1.6;}

#stopBtn{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.75);border:1px solid var(--a2);color:var(--a2);font-family:'Rajdhani',sans-serif;font-size:0.62rem;letter-spacing:0.1em;text-transform:uppercase;padding:5px 12px;border-radius:6px;cursor:pointer;display:none;}
.fps{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.65);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-family:'Orbitron',monospace;font-size:0.52rem;color:var(--a4);letter-spacing:0.1em;display:none;}

.badge{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(3,3,12,0.93);border:1.5px solid var(--a);border-radius:20px;padding:10px 26px;text-align:center;backdrop-filter:blur(16px);min-width:190px;box-shadow:0 0 30px rgba(0,229,255,0.2);display:none;transition:border-color 0.2s;}
.badge.nh{border-color:var(--muted);}
.be{font-size:clamp(1.8rem,8vw,2.8rem);display:block;line-height:1;margin-bottom:2px;}
.bn{font-family:'Orbitron',monospace;font-size:clamp(0.9rem,4vw,1.3rem);font-weight:700;color:var(--a);letter-spacing:0.08em;line-height:1.1;}
.badge.nh .bn{color:var(--muted);}
.bs{font-size:0.6rem;color:var(--muted);letter-spacing:0.08em;margin-top:1px;}
.cb{width:100%;height:4px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-top:6px;}
.cf{height:100%;border-radius:2px;transition:width 0.1s,background 0.2s;background:var(--a);box-shadow:0 0 6px var(--a);}
.cl{display:flex;justify-content:space-between;margin-top:2px;}
.cl span{font-size:0.55rem;color:var(--muted);letter-spacing:0.08em;}

/* stability meter */
.stab{position:absolute;right:14px;bottom:80px;display:none;flex-direction:column;gap:3px;align-items:center;}
.stab-b{width:4px;border-radius:2px;background:var(--border);}

.bottom{flex-shrink:0;background:var(--s1);border-top:1px solid var(--border);max-height:36vh;display:flex;flex-direction:column;}
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:9px 2px;font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;font-family:'Rajdhani',sans-serif;font-weight:700;}
.tab.on{color:var(--a);border-bottom-color:var(--a);}
.pb{flex:1;overflow-y:auto;padding:8px 12px;-webkit-overflow-scrolling:touch;}
.pb::-webkit-scrollbar{display:none;}
.pane{display:none;}
.pane.on{display:block;}

.cat{font-size:0.56rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin:7px 0 4px;}
.cat:first-child{margin-top:0;}
.chips{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:4px;}
.chip{display:flex;align-items:center;gap:4px;background:var(--s2);border:1px solid var(--border);border-radius:100px;padding:3px 8px;font-size:0.6rem;color:var(--muted);transition:all 0.15s;white-space:nowrap;font-weight:600;}
.chip.on{border-color:var(--a);color:var(--a);background:rgba(0,229,255,0.08);box-shadow:0 0 8px rgba(0,229,255,0.12);}
.chip.rc{border-color:var(--a3);color:var(--a3);background:rgba(255,229,0,0.05);}
.ce{font-size:0.9rem;}

.li{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);}
.lt{color:var(--muted);font-size:0.56rem;min-width:48px;}
.le{font-size:0.95rem;}
.ln{font-size:0.68rem;font-weight:600;}
.lbar{width:28px;height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-left:auto;}
.lbf{height:100%;background:var(--a4);border-radius:2px;}
.lc{color:var(--muted);font-size:0.56rem;min-width:28px;text-align:right;}

.sr{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);}
.sl{font-size:0.62rem;color:var(--muted);font-weight:600;}
.sv{font-size:0.88rem;color:var(--a);font-family:'Orbitron',monospace;font-weight:700;}

@keyframes pop{0%{transform:translateX(-50%) scale(1)}40%{transform:translateX(-50%) scale(1.05)}100%{transform:translateX(-50%) scale(1)}}
.pop{animation:pop 0.2s ease;}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">HANDSPEAK<sup>PRO</sup></div>
    <div class="hr">
      <div class="camBtn" id="camBtn" onclick="flipCam()">üîÑ <span id="camLbl">FRONT</span></div>
      <div class="pill"><div class="dot" id="dot"></div><span id="stxt">OFF</span></div>
    </div>
  </header>

  <div class="camwrap">
    <video id="vid" autoplay playsinline muted></video>
    <canvas id="cvs"></canvas>
    <div class="scan"></div>
    <div class="cn tl"></div><div class="cn tr"></div><div class="cn bl"></div><div class="cn br"></div>

    <div class="ph" id="ph" onclick="startCam()">
      <div class="ph-ring">üñê</div>
      <div class="ph-label">TAP TO START</div>
      <p class="ph-sub">28 gestures ¬∑ Numbers ¬∑ ASL ¬∑ Signs<br>Front & back camera</p>
    </div>

    <button id="stopBtn" onclick="stopCam()">‚úï STOP</button>
    <div class="fps" id="fps">-- FPS</div>

    <div class="badge nh" id="badge">
      <span class="be" id="be">‚Äî</span>
      <div class="bn" id="bn">‚Äî</div>
      <div class="bs" id="bs">Show your hand</div>
      <div class="cb"><div class="cf" id="cf" style="width:0%"></div></div>
      <div class="cl"><span>CONFIDENCE</span><span id="cp">0%</span></div>
    </div>
  </div>

  <div class="bottom">
    <div class="tabs">
      <div class="tab on" onclick="sw('g',this)">Gestures</div>
      <div class="tab" onclick="sw('l',this)">History</div>
      <div class="tab" onclick="sw('s',this)">Stats</div>
    </div>
    <div class="pb">
      <div class="pane on" id="pg">
        <div class="cat">Numbers (0-9)</div><div class="chips" id="c-n"></div>
        <div class="cat">Hand Signs</div><div class="chips" id="c-s"></div>
        <div class="cat">Gestures</div><div class="chips" id="c-g"></div>
        <div class="cat">ASL Letters</div><div class="chips" id="c-a"></div>
      </div>
      <div class="pane" id="pl"><div id="log"></div></div>
      <div class="pane" id="ps">
        <div class="sr"><span class="sl">Total Detections</span><span class="sv" id="sTot">0</span></div>
        <div class="sr"><span class="sl">Most Common</span><span class="sv" id="sCom" style="font-family:'Rajdhani',sans-serif;font-size:0.75rem">‚Äî</span></div>
        <div class="sr"><span class="sl">Avg Confidence</span><span class="sv" id="sAv">‚Äî</span></div>
        <div class="sr"><span class="sl">Unique Gestures</span><span class="sv" id="sUn">0</span></div>
        <div class="sr"><span class="sl">Session Time</span><span class="sv" id="sTm">00:00</span></div>
        <div class="sr"><span class="sl">Camera</span><span class="sv" id="sCam" style="font-family:'Rajdhani',sans-serif;font-size:0.7rem">‚Äî</span></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js" crossorigin="anonymous"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GESTURE DATABASE ‚Äî 28 gestures
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  n:[
    {id:'g0',name:'Zero',emoji:'0Ô∏è‚É£',desc:'Pinched circle'},
    {id:'g1',name:'One',emoji:'1Ô∏è‚É£',desc:'Index up'},
    {id:'g2',name:'Two',emoji:'2Ô∏è‚É£',desc:'Index + middle'},
    {id:'g3',name:'Three',emoji:'3Ô∏è‚É£',desc:'Three fingers'},
    {id:'g4',name:'Four',emoji:'4Ô∏è‚É£',desc:'Four fingers'},
    {id:'g5',name:'Five',emoji:'5Ô∏è‚É£',desc:'All five'},
    {id:'g6',name:'Six',emoji:'6Ô∏è‚É£',desc:'Thumb + pinky'},
    {id:'g7',name:'Seven',emoji:'7Ô∏è‚É£',desc:'Thumb+ring+pinky'},
    {id:'g8',name:'Eight',emoji:'8Ô∏è‚É£',desc:'Thumb+mid+pinky'},
    {id:'g9',name:'Nine',emoji:'9Ô∏è‚É£',desc:'Thumb-index touch'},
  ],
  s:[
    {id:'thu',name:'Thumbs Up',emoji:'üëç',desc:'Great job!'},
    {id:'thd',name:'Thumbs Down',emoji:'üëé',desc:'Nope'},
    {id:'pea',name:'Peace / V',emoji:'‚úåÔ∏è',desc:'Victory sign'},
    {id:'rok',name:'Rock On',emoji:'ü§ò',desc:'Index + pinky'},
    {id:'ok' ,name:'OK Sign',emoji:'üëå',desc:'Circle + 3 up'},
    {id:'stp',name:'Stop',emoji:'üõë',desc:'Palm forward'},
    {id:'pnt',name:'Point',emoji:'üëÜ',desc:'Index pointing'},
    {id:'cal',name:'Call Me',emoji:'ü§ô',desc:'Thumb + pinky'},
    {id:'pin',name:'Pinch',emoji:'ü§å',desc:'Chef\'s kiss'},
    {id:'gun',name:'Finger Gun',emoji:'ü´µ',desc:'Thumb + index'},
  ],
  g:[
    {id:'fst',name:'Fist',emoji:'‚úä',desc:'Power fist'},
    {id:'opn',name:'Open Hand',emoji:'üñê',desc:'Hi there!'},
    {id:'vul',name:'Vulcan',emoji:'üññ',desc:'Live long & prosper'},
    {id:'crs',name:'Crossed',emoji:'ü§û',desc:'Good luck!'},
    {id:'shk',name:'Shaka',emoji:'ü§ô',desc:'Hang loose'},
    {id:'wav',name:'Wave',emoji:'üëã',desc:'Hello / goodbye'},
  ],
  a:[
    {id:'aA',name:'ASL ‚Äî A',emoji:'üÖ∞Ô∏è',desc:'Fist, thumb aside'},
    {id:'aB',name:'ASL ‚Äî B',emoji:'üÖ±Ô∏è',desc:'Flat four fingers'},
    {id:'aC',name:'ASL ‚Äî C',emoji:'¬©Ô∏è',desc:'Curved C'},
    {id:'aD',name:'ASL ‚Äî D',emoji:'üî§',desc:'D shape'},
  ]
};
const ALL=[...DB.n,...DB.s,...DB.g,...DB.a];
const byId={};ALL.forEach(g=>byId[g.id]=g);

const catMap={n:'c-n',s:'c-s',g:'c-g',a:'c-a'};
Object.entries(DB).forEach(([cat,gs])=>{
  const w=document.getElementById(catMap[cat]);
  gs.forEach(g=>{const c=document.createElement('div');c.className='chip';c.id='ch-'+g.id;c.innerHTML=`<span class="ce">${g.emoji}</span>${g.name}`;w.appendChild(c);});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let running=false,mpHands=null,cam=null,front=true;
let lastId=null,prevChip=null;
let st={tot:0,map:{},cs:0,start:null};
let fc=0,ft=0;

// Multi-frame smoothing buffers
const VOTE_N=5, LOCK_N=3;
let voteBuf=[], lockBuf=[];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CAMERA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startCam(){
  document.getElementById('ph').style.display='none';
  const vid=document.getElementById('vid'),cvs=document.getElementById('cvs');

  mpHands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${f}`});
  mpHands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.78,minTrackingConfidence:0.65});
  mpHands.onResults(onRes);

  cam=new Camera(vid,{
    onFrame:async()=>{if(mpHands)await mpHands.send({image:vid});fc++;const n=performance.now();if(n-ft>1000){document.getElementById('fps').textContent=Math.round(fc*1000/(n-ft))+' FPS';ft=n;fc=0;}},
    width:1280,height:720,facingMode:front?'user':'environment'
  });
  await cam.start();
  vid.addEventListener('loadeddata',()=>{cvs.width=vid.videoWidth;cvs.height=vid.videoHeight;},{once:true});

  // Mirror only front cam
  vid.className=front?'mir':'';
  cvs.className=front?'mir':'';

  running=true;
  document.getElementById('stopBtn').style.display='block';
  document.getElementById('badge').style.display='block';
  document.getElementById('fps').style.display='block';
  document.getElementById('camBtn').style.display='flex';
  document.getElementById('dot').classList.add('live');
  document.getElementById('stxt').textContent='LIVE';
  document.getElementById('sCam').textContent=front?'Front Camera':'Back Camera';
  document.getElementById('camLbl').textContent=front?'FRONT':'BACK';
  st.start=Date.now();
  tick();
}

function stopCam(){
  if(cam){cam.stop();cam=null;}
  if(mpHands){mpHands.close();mpHands=null;}
  running=false;voteBuf=[];lockBuf=[];
  const cvs=document.getElementById('cvs');
  cvs.getContext('2d').clearRect(0,0,cvs.width,cvs.height);
  document.getElementById('ph').style.display='flex';
  document.getElementById('stopBtn').style.display='none';
  document.getElementById('badge').style.display='none';
  document.getElementById('fps').style.display='none';
  document.getElementById('camBtn').style.display='none';
  document.getElementById('dot').classList.remove('live');
  document.getElementById('stxt').textContent='OFF';
  if(prevChip){document.getElementById('ch-'+prevChip)?.classList.remove('on');prevChip=null;}
}

async function flipCam(){
  front=!front;
  stopCam();
  await new Promise(r=>setTimeout(r,400));
  await startCam();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onRes(res){
  const vid=document.getElementById('vid'),cvs=document.getElementById('cvs');
  cvs.width=vid.videoWidth||640;cvs.height=vid.videoHeight||480;
  const ctx=cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  let best=null;
  if(res.multiHandLandmarks?.length){
    for(let i=0;i<res.multiHandLandmarks.length;i++){
      const lm=res.multiHandLandmarks[i];
      const hand=res.multiHandedness?.[i]?.label||'Right';
      drawHand(ctx,lm,cvs.width,cvs.height,hand);
      const g=classify(lm,hand);
      if(g&&(!best||g.conf>best.conf))best=g;
    }
  }

  // Smoothing
  if(best){
    voteBuf.push(best);if(voteBuf.length>VOTE_N)voteBuf.shift();
    const votes={};
    voteBuf.forEach(d=>{if(!votes[d.id])votes[d.id]={n:0,cs:0};votes[d.id].n++;votes[d.id].cs+=d.conf;});
    const top=Object.entries(votes).sort((a,b)=>b[1].n-a[1].n)[0];
    const topId=top[0];
    const topConf=votes[topId].cs/votes[topId].n;
    lockBuf.push(topId);if(lockBuf.length>LOCK_N)lockBuf.shift();
    if(lockBuf.length===LOCK_N&&lockBuf.every(x=>x===topId)){
      showG({id:topId,conf:topConf});
    }
  } else {
    voteBuf=[];lockBuf=[];showG(null);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAWING ‚Äî multi-color per finger
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BONES=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[0,17],[17,18],[18,19],[19,20]];
const COLS=['#ff2d6b','#ff2d6b','#ff2d6b','#ff2d6b','#ff2d6b','#00e5ff','#00e5ff','#00e5ff','#00e5ff','#00ff88','#00ff88','#00ff88','#00ff88','#ffe500','#ffe500','#ffe500','#ffe500','#ff8c00','#ff8c00','#ff8c00','#ff8c00'];

function drawHand(ctx,lm,w,h,hand){
  BONES.forEach(([a,b])=>{
    const grd=ctx.createLinearGradient(lm[a].x*w,lm[a].y*h,lm[b].x*w,lm[b].y*h);
    grd.addColorStop(0,COLS[a]+'88');grd.addColorStop(1,COLS[b]+'88');
    ctx.beginPath();ctx.strokeStyle=grd;ctx.lineWidth=3;
    ctx.shadowColor=COLS[b];ctx.shadowBlur=6;
    ctx.moveTo(lm[a].x*w,lm[a].y*h);ctx.lineTo(lm[b].x*w,lm[b].y*h);ctx.stroke();ctx.shadowBlur=0;
  });
  const TIPS=[4,8,12,16,20];
  lm.forEach((p,i)=>{
    const c=COLS[i]||'#fff';const r=i===0?7:TIPS.includes(i)?5:3.5;
    ctx.beginPath();ctx.fillStyle=c;ctx.shadowColor=c;ctx.shadowBlur=10;
    ctx.arc(p.x*w,p.y*h,r,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
    if(TIPS.includes(i)){ctx.beginPath();ctx.fillStyle='rgba(255,255,255,0.85)';ctx.arc(p.x*w,p.y*h,1.5,0,Math.PI*2);ctx.fill();}
  });
  // hand label
  const lx=lm[0].x*w,ly=lm[0].y*h;
  ctx.fillStyle='rgba(0,0,5,0.65)';ctx.fillRect(lx-22,ly-23,44,15);
  ctx.fillStyle='#00e5ff';ctx.font='bold 10px Orbitron,monospace';ctx.textAlign='center';
  ctx.fillText(hand.toUpperCase(),lx,ly-11);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ULTRA-ACCURATE CLASSIFIER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function geo(lm){
  const L=lm;
  const d=(a,b)=>Math.hypot(L[a].x-L[b].x,L[a].y-L[b].y);

  // Finger extension: check tip vs pip (vertical) AND tip vs mcp
  function ext(tip,dip,pip,mcp){
    return L[tip].y < L[pip].y-0.022 && L[tip].y < L[mcp].y+0.01;
  }
  // Also check curl: tip below pip = curled
  function curl(tip,pip){return L[tip].y > L[pip].y+0.015;}

  // Thumb: use x-axis. Detect if right or left hand by geometry
  const rightHand=L[5].x > L[17].x; // index mcp right of pinky mcp
  const thumbExt=rightHand ? L[4].x>L[2].x+0.025 : L[4].x<L[2].x-0.025;
  // Also check thumb vertical for thumbs up/down
  const thumbUp=L[4].y<L[3].y-0.03;
  const thumbDown=L[4].y>L[3].y+0.05;

  const iExt=ext(8,7,6,5);
  const mExt=ext(12,11,10,9);
  const rExt=ext(16,15,14,13);
  const pExt=ext(20,19,18,17);

  const iCurl=curl(8,6);
  const mCurl=curl(12,10);
  const rCurl=curl(16,14);
  const pCurl=curl(20,18);

  // Precise distances
  const dist={
    ti:d(4,8),tm:d(4,12),tr:d(4,16),tp:d(4,20),
    im:d(8,12),mr:d(12,16),rp:d(16,20),ip:d(8,20),
    w8:d(0,8),w12:d(0,12)
  };

  // Spread of all fingertips
  const spread=d(8,20);

  // Middle-ring gap for vulcan
  const mrGap=Math.abs(L[12].x-L[16].x);

  // Index-middle angle (for crossed fingers)
  const crossedX=Math.abs(L[8].x-L[12].x)<0.025;

  return {T:thumbExt,I:iExt,M:mExt,R:rExt,P:pExt,
    thumbUp,thumbDown,iCurl,mCurl,rCurl,pCurl,
    dist,spread,mrGap,crossedX,rightHand,L};
}

function classify(lm){
  const {T,I,M,R,P,thumbUp,thumbDown,iCurl,mCurl,rCurl,pCurl,dist,spread,mrGap,crossedX,L}=geo(lm);
  const nExt=[T,I,M,R,P].filter(Boolean).length;

  // ‚îÄ‚îÄ FIST (check first ‚Äî most common) ‚îÄ‚îÄ
  if(!T&&!I&&!M&&!R&&!P) return{id:'fst',conf:0.97};
  if(nExt===0) return{id:'fst',conf:0.94};

  // ‚îÄ‚îÄ ALL FIVE ‚îÄ‚îÄ
  if(T&&I&&M&&R&&P){
    if(mrGap>0.08) return{id:'vul',conf:0.92};
    if(spread>0.28) return{id:'stp',conf:0.90};
    return{id:'g5',conf:0.88};
  }

  // ‚îÄ‚îÄ FOUR ‚îÄ‚îÄ
  if(!T&&I&&M&&R&&P) return{id:'g4',conf:0.95};

  // ‚îÄ‚îÄ THREE ‚îÄ‚îÄ
  if(!T&&I&&M&&R&&!P) return{id:'g3',conf:0.93};

  // ‚îÄ‚îÄ TWO / PEACE ‚îÄ‚îÄ
  if(!T&&I&&M&&!R&&!P){
    if(crossedX) return{id:'crs',conf:0.88};
    if(dist.im>0.05) return{id:'pea',conf:0.93};
    return{id:'g2',conf:0.91};
  }

  // ‚îÄ‚îÄ ONE / POINT ‚îÄ‚îÄ
  if(!T&&I&&!M&&!R&&!P){
    if(L[8].y<L[5].y-0.05) return{id:'pnt',conf:0.92};
    return{id:'g1',conf:0.94};
  }
  if(T&&I&&!M&&!R&&!P) return{id:'pnt',conf:0.88};

  // ‚îÄ‚îÄ THUMB GESTURES ‚îÄ‚îÄ
  if(T&&!I&&!M&&!R&&!P){
    if(thumbUp) return{id:'thu',conf:0.96};
    if(thumbDown) return{id:'thd',conf:0.95};
    return{id:'thu',conf:0.85};
  }

  // ‚îÄ‚îÄ OK ‚îÄ‚îÄ
  if(dist.ti<0.065&&M&&R&&P) return{id:'ok',conf:0.91+Math.max(0,0.065-dist.ti)};

  // ‚îÄ‚îÄ NINE ‚îÄ‚îÄ
  if(dist.ti<0.06&&!M&&!R&&!P) return{id:'g9',conf:0.89};

  // ‚îÄ‚îÄ ZERO ‚îÄ‚îÄ
  if(!I&&!M&&!R&&!P&&dist.ti<0.08) return{id:'g0',conf:0.87};

  // ‚îÄ‚îÄ PINCH ‚îÄ‚îÄ
  if(dist.ti<0.055&&!M&&!R&&!P) return{id:'pin',conf:0.91};

  // ‚îÄ‚îÄ ROCK ‚îÄ‚îÄ
  if(!T&&I&&!M&&!R&&P) return{id:'rok',conf:0.95};

  // ‚îÄ‚îÄ CALL ME / SHAKA ‚îÄ‚îÄ
  if(T&&!I&&!M&&!R&&P){
    if(dist.tp>0.32) return{id:'shk',conf:0.88};
    return{id:'cal',conf:0.93};
  }

  // ‚îÄ‚îÄ FINGER GUN ‚îÄ‚îÄ
  if(T&&I&&!M&&!R&&!P) return{id:'gun',conf:0.90};

  // ‚îÄ‚îÄ SIX (thumb + pinky, others curled) ‚îÄ‚îÄ
  if(T&&!I&&!M&&!R&&P&&!M) return{id:'g6',conf:0.87};

  // ‚îÄ‚îÄ SEVEN (thumb + ring + pinky) ‚îÄ‚îÄ
  if(T&&!I&&!M&&R&&P) return{id:'g7',conf:0.86};

  // ‚îÄ‚îÄ EIGHT (thumb + middle + pinky) ‚îÄ‚îÄ
  if(T&&!I&&M&&!R&&P) return{id:'g8',conf:0.85};

  // ‚îÄ‚îÄ OPEN HAND (relaxed) ‚îÄ‚îÄ
  if(nExt>=4) return{id:'opn',conf:0.83};

  // ‚îÄ‚îÄ WAVE ‚îÄ‚îÄ
  if(I&&M&&R&&P&&!T) return{id:'wav',conf:0.80};

  // ‚îÄ‚îÄ ASL A: fist, thumb presses side ‚îÄ‚îÄ
  if(!I&&!M&&!R&&!P&&T&&dist.ti<0.14) return{id:'aA',conf:0.82};

  // ‚îÄ‚îÄ ASL B: flat four, thumb in ‚îÄ‚îÄ
  if(!T&&I&&M&&R&&P&&dist.ti>0.12) return{id:'aB',conf:0.80};

  // ‚îÄ‚îÄ ASL C: curved open ‚îÄ‚îÄ
  if(!I&&!M&&!R&&!P&&dist.ti>0.08&&dist.ti<0.2) return{id:'aC',conf:0.78};

  // ‚îÄ‚îÄ ASL D: index up, others curl to thumb ‚îÄ‚îÄ
  if(I&&!M&&!R&&!P&&dist.ti<0.1&&!T) return{id:'aD',conf:0.79};

  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showG(det){
  const badge=document.getElementById('badge');
  const be=document.getElementById('be'),bn=document.getElementById('bn'),bs=document.getElementById('bs');
  const cf=document.getElementById('cf'),cp=document.getElementById('cp');

  if(det){
    const g=byId[det.id];if(!g)return;
    be.textContent=g.emoji;bn.textContent=g.name.toUpperCase();bs.textContent=g.desc;
    const pct=Math.min(99,Math.round(det.conf*100));
    cf.style.width=pct+'%';
    cf.style.background=pct>88?'var(--a4)':pct>72?'var(--a)':'var(--a3)';
    cf.style.boxShadow=`0 0 6px ${pct>88?'var(--a4)':pct>72?'var(--a)':'var(--a3)'}`;
    cp.textContent=pct+'%';
    badge.classList.remove('nh');

    if(prevChip&&prevChip!==det.id) document.getElementById('ch-'+prevChip)?.classList.remove('on');
    document.getElementById('ch-'+det.id)?.classList.add('on');
    prevChip=det.id;

    if(det.id!==lastId){
      badge.classList.add('pop');setTimeout(()=>badge.classList.remove('pop'),200);
      addLog(g,det.conf);updStats(g,det.conf);lastId=det.id;
    }
  } else {
    be.textContent='‚Äî';bn.textContent='NO HAND';bs.textContent='Show your hand to the camera';
    cf.style.width='0%';cp.textContent='0%';badge.classList.add('nh');lastId=null;
    if(prevChip){document.getElementById('ch-'+prevChip)?.classList.remove('on');prevChip=null;}
  }
}

function addLog(g,conf){
  const t=new Date().toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const el=document.createElement('div');el.className='li';
  el.innerHTML=`<span class="lt">${t}</span><span class="le">${g.emoji}</span><span class="ln">${g.name}</span><div class="lbar"><div class="lbf" style="width:${Math.round(conf*100)}%"></div></div><span class="lc">${Math.round(conf*100)}%</span>`;
  const l=document.getElementById('log');l.insertBefore(el,l.firstChild);
  while(l.children.length>80)l.removeChild(l.lastChild);
}

function updStats(g,conf){
  st.tot++;st.cs+=conf;st.map[g.id]=(st.map[g.id]||0)+1;
  document.getElementById('sTot').textContent=st.tot;
  const top=Object.entries(st.map).sort((a,b)=>b[1]-a[1])[0];
  if(top){const tg=byId[top[0]];document.getElementById('sCom').textContent=tg.emoji+' '+tg.name;}
  document.getElementById('sAv').textContent=Math.round(st.cs/st.tot*100)+'%';
  document.getElementById('sUn').textContent=Object.keys(st.map).length;
}

function tick(){
  if(!st.start)return;
  const e=Math.floor((Date.now()-st.start)/1000);
  document.getElementById('sTm').textContent=String(Math.floor(e/60)).padStart(2,'0')+':'+String(e%60).padStart(2,'0');
  setTimeout(tick,1000);
}

function sw(n,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.pane').forEach(p=>p.classList.remove('on'));
  el.classList.add('on');
  document.getElementById('p'+n).classList.add('on');
}
</script>
</body>
</html>
